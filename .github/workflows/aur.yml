name: Update AUR

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths: [PKGBUILD]

jobs:
  publish:
    runs-on: ubuntu-latest
    container: archlinux:base-devel
    steps:
      - uses: actions/checkout@v4

      - run: |
          useradd -m builder
          chown -R builder: .
          su builder -c 'makepkg --printsrcinfo > .SRCINFO'

      - name: Push to AUR
        env:
          AUR_SSH_KEY: ${{ secrets.AUR_SSH_KEY }}
        run: |
          pacman -Sy --noconfirm openssh git
          mkdir -p ~/.ssh
          echo "$AUR_SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          echo "aur.archlinux.org ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIEuBKrPzbawxA/k2g6NcyV5jmqwJ2s+zpgZGZ7tpLIhd" >> ~/.ssh/known_hosts
          git config --global safe.directory "$GITHUB_WORKSPACE"
          git config user.name "Barrett Ruth"
          git config user.email "barrettruth@gmail.com"
          git remote add aur ssh://aur@aur.archlinux.org/sioyek-dev.git
          git add .SRCINFO
          git diff --cached --quiet || git commit -m "update .SRCINFO"
          git push aur HEAD:main
